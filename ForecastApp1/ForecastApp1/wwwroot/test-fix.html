<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/minimal.css">
    <style>
        .fix-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .sql-query {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üîß –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞</h1>
            <a href="/main.html" class="nav-button">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</a>
        </div>
    </header>

    <div class="container">
        <div class="content-wrapper">
            <h2>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ!</h2>
            
            <div class="fix-info">
                <h3>‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞</h3>
                <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –°–∏—Å—Ç–µ–º–∞ –∏—Å–∫–∞–ª–∞ –¥–æ–ª–≥–∏ –Ω–∞ –æ–±—â—É—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É, –∞ –Ω–µ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞.</p>
                <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ <code>PaymentScheduleService.cs</code></p>
            </div>

            <div class="test-section">
                <h3>üìä –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï –†–ê–ë–û–¢–ê–õ–ê):</h3>
                <div class="sql-query">
SELECT supplier_code, internal_contract_number, debt_amount
FROM incoming_debt
WHERE debt_date = (
    SELECT MAX(debt_date) 
    FROM incoming_debt 
    WHERE debt_date <= '2025-08-01'
)
AND internal_contract_number = '270';
                </div>
                <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ò—â–µ—Ç –¥–æ–ª–≥–∏ –Ω–∞ –¥–∞—Ç—É 2025-07-31, –Ω–æ –¥–æ–≥–æ–≤–æ—Ä 270 –∏–º–µ–µ—Ç –¥–æ–ª–≥ –Ω–∞ 2025-07-30</p>
            </div>

            <div class="test-section">
                <h3>‚úÖ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–†–ê–ë–û–¢–ê–ï–¢):</h3>
                <div class="sql-query">
SELECT supplier_code, internal_contract_number, debt_amount
FROM incoming_debt
WHERE debt_date = (
    SELECT MAX(debt_date) 
    FROM incoming_debt 
    WHERE debt_date <= '2025-08-01'
    AND internal_contract_number = '270'
)
AND internal_contract_number = '270';
                </div>
                <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ò—â–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–æ–ª–≥–∞ –∏–º–µ–Ω–Ω–æ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ 270 (2025-07-30)</p>
            </div>

            <div class="test-section">
                <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                <p>–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å—á–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ 270 —Å –¥–∞—Ç–æ–π 01.08.2025</p>
                
                <div class="form-group">
                    <button onclick="testPaymentCalculation()" style="background: #28a745; color: white; padding: 1rem 2rem; border: none; border-radius: 4px; cursor: pointer;">
                        üßÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
                    </button>
                </div>
            </div>

            <div id="test-results"></div>
        </div>
    </div>

    <script>
        async function testPaymentCalculation() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π...</p>';

            try {
                const response = await fetch('/api/payments/schedule?startDate=2025-08-01&contract=270');
                const data = await response.json();
                
                if (data.length > 0) {
                    resultsDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <h3>‚úÖ –£—Å–ø–µ—Ö! –†–∞—Å—á–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!</h3>
                            <p><strong>–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:</strong> ${data.length}</p>
                            <p><strong>–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å:</strong></p>
                            <ul>
                                <li>–ü–æ—Å—Ç–∞–≤—â–∏–∫: ${data[0].supplierCode}</li>
                                <li>–î–æ–≥–æ–≤–æ—Ä: ${data[0].internalContractNumber}</li>
                                <li>–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏: ${new Date(data[0].shipmentDocDate).toLocaleDateString('ru-RU')}</li>
                                <li>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞: ${new Date(data[0].paymentDate).toLocaleDateString('ru-RU')}</li>
                                <li>–°—É–º–º–∞: ${data[0].totalAmount.toLocaleString('ru-RU')} —Ä—É–±.</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <h3>‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å</h3>
                            <p>–†–∞—Å—á–µ—Ç –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã—Ö. –í–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                        <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                        <p>–û—à–∏–±–∫–∞: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
