<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/minimal.css">
    <style>
        .analysis-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .duplicate-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .solution-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üîç –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö</h1>
            <a href="/main.html" class="nav-button">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</a>
        </div>
    </header>

    <div class="container">
        <div class="content-wrapper">
            <h2>–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è –∑–∞–ø–∏—Å—è–º–∏</h2>
            
            <div class="duplicate-info">
                <h3>üö® –ü—Ä–æ–±–ª–µ–º–∞:</h3>
                <p>–í —Ç–∞–±–ª–∏—Ü–µ <code>payment_schedule</code> –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–º —Ä–∞—Å—á–µ—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π.</p>
            </div>

            <div class="solution-info">
                <h3>‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ:</h3>
                <ul>
                    <li><strong>–î–æ–±–∞–≤–ª–µ–Ω DISTINCT</strong> –≤ SQL –∑–∞–ø—Ä–æ—Å—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞</li>
                    <li><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</strong> –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ</li>
                    <li><strong>–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</strong> –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</li>
                </ul>
            </div>

            <div class="analysis-section">
                <h3>üìä –ü–æ—á–µ–º—É –≤–æ–∑–Ω–∏–∫–∞—é—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ:</h3>
                <ol>
                    <li><strong>–ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç:</strong> –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏</li>
                    <li><strong>–†–∞–∑–Ω—ã–µ –¥–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:</strong> –ó–∞–ø–∏—Å–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –Ω–æ —Ä–∞–∑–Ω—ã–º–∏ <code>calculation_date</code></li>
                    <li><strong>–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞:</strong> –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π</li>
                </ol>
            </div>

            <div class="analysis-section">
                <h3>üîß –ü–æ—á–µ–º—É –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:</h3>
                <p>–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ <code>ON CONFLICT</code>:</p>
                <pre style="background: #e9ecef; padding: 1rem; border-radius: 4px; font-size: 0.9em;">
INSERT INTO incoming_debt (supplier_code, debt_date, debt_amount, internal_contract_number)
VALUES (@s, @date, @amount, @contract)
ON CONFLICT (supplier_code, debt_date, internal_contract_number)
DO UPDATE SET debt_amount = EXCLUDED.debt_amount;</pre>
            </div>

            <div class="analysis-section">
                <h3>üßÆ –ü–æ—á–µ–º—É —Ä–∞—Å—á–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:</h3>
                <p>–í <code>PaymentScheduleService.cs</code> –µ—Å—Ç—å –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π:</p>
                <pre style="background: #e9ecef; padding: 1rem; border-radius: 4px; font-size: 0.9em;">
DELETE FROM payment_schedule 
WHERE calculation_date = @CalcDate
  AND (@Contract IS NULL OR internal_contract_number = @Contract)</pre>
                <p><strong>–ù–æ:</strong> –ï—Å–ª–∏ –≤—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏, —Ç–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è!</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <button onclick="testDuplicateFiltering()" class="btn">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</button>
                </div>
            </div>

            <div id="test-results"></div>
        </div>
    </div>

    <script>
        async function testDuplicateFiltering() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>‚è≥ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –¥—É–±–ª–∏–∫–∞—Ç–æ–≤...</p>';

            try {
                const response = await fetch('/api/paymentschedule/all');
                const data = await response.json();
                
                // –ü–æ–¥—Å—á–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                const duplicates = data.filter((item, index, self) => 
                    index !== self.findIndex(t => 
                        t.supplierCode === item.supplierCode &&
                        t.internalContractNumber === item.internalContractNumber &&
                        t.orderNumber === item.orderNumber &&
                        t.shipmentDocNumber === item.shipmentDocNumber &&
                        t.shipmentDocDate === item.shipmentDocDate &&
                        t.totalAmount === item.totalAmount
                    )
                );

                const uniqueData = data.filter((item, index, self) => 
                    index === self.findIndex(t => 
                        t.supplierCode === item.supplierCode &&
                        t.internalContractNumber === item.internalContractNumber &&
                        t.orderNumber === item.orderNumber &&
                        t.shipmentDocNumber === item.shipmentDocNumber &&
                        t.shipmentDocDate === item.shipmentDocDate &&
                        t.totalAmount === item.totalAmount
                    )
                );

                resultsDiv.innerHTML = `
                    <div class="analysis-section">
                        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:</h3>
                        <ul>
                            <li><strong>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</strong> ${data.length}</li>
                            <li><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:</strong> ${uniqueData.length}</li>
                            <li><strong>–î—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π:</strong> ${duplicates.length}</li>
                            <li><strong>–ü—Ä–æ—Ü–µ–Ω—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:</strong> ${((duplicates.length / data.length) * 100).toFixed(1)}%</li>
                        </ul>
                    </div>
                `;

                if (duplicates.length > 0) {
                    resultsDiv.innerHTML += `
                        <div class="duplicate-info">
                            <h3>üîç –ü—Ä–∏–º–µ—Ä—ã –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π:</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #e9ecef;">
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–î–æ–≥–æ–≤–æ—Ä</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–ó–∞–∫–∞–∑</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–î–æ–∫—É–º–µ–Ω—Ç</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</th>
                                        <th style="border: 1px solid #dee2e6; padding: 0.5rem;">–°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${duplicates.slice(0, 5).map(item => `
                                        <tr>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${item.supplierCode}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${item.internalContractNumber}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${item.orderNumber}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${item.shipmentDocNumber}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${new Date(item.shipmentDocDate).toLocaleDateString('ru-RU')}</td>
                                            <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${item.totalAmount.toLocaleString('ru-RU')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML += `
                        <div class="solution-info">
                            <h3>‚úÖ –û—Ç–ª–∏—á–Ω–æ!</h3>
                            <p>–î—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
                        </div>
                    `;
                }

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="duplicate-info">
                        <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                        <p>–û—à–∏–±–∫–∞: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
