@model WebApplication5_Calculator.Models.5_CalculatorModel
@{
    ViewData["Title"] = "Калькулятор";
}

<div class="calculator">
    <div class="calculator-display" id="display">0</div>
    <div class="calculator-buttons">
        <!-- Первый ряд: Очистка и операции -->
        <button class="calc-btn clear" onclick="clearDisplay()" title="Очистить (C)">C</button>
        <button class="calc-btn clear" onclick="deleteLast()" title="Удалить (Backspace)">⌫</button>
        <button class="calc-btn operator" onclick="appendOperator('/')" title="Деление (/)">÷</button>
        <button class="calc-btn operator" onclick="appendOperator('*')" title="Умножение (*)">×</button>
        
        <!-- Второй ряд: 7, 8, 9, - -->
        <button class="calc-btn number" onclick="appendNumber('7')" title="7">7</button>
        <button class="calc-btn number" onclick="appendNumber('8')" title="8">8</button>
        <button class="calc-btn number" onclick="appendNumber('9')" title="9">9</button>
        <button class="calc-btn operator" onclick="appendOperator('-')" title="Вычитание (-)">−</button>
        
        <!-- Третий ряд: 4, 5, 6, + -->
        <button class="calc-btn number" onclick="appendNumber('4')" title="4">4</button>
        <button class="calc-btn number" onclick="appendNumber('5')" title="5">5</button>
        <button class="calc-btn number" onclick="appendNumber('6')" title="6">6</button>
        <button class="calc-btn operator" onclick="appendOperator('+')" title="Сложение (+)">+</button>
        
        <!-- Четвертый ряд: 1, 2, 3, = -->
        <button class="calc-btn number" onclick="appendNumber('1')" title="1">1</button>
        <button class="calc-btn number" onclick="appendNumber('2')" title="2">2</button>
        <button class="calc-btn number" onclick="appendNumber('3')" title="3">3</button>
        <button class="calc-btn equals" onclick="calculate()" title="Равно (= или Enter)">=</button>
        
        <!-- Пятый ряд: 0, . -->
        <button class="calc-btn number zero" onclick="appendNumber('0')" title="0">0</button>
        <button class="calc-btn number" onclick="appendDecimal()" title="Точка (.)">.</button>
    </div>
</div>

@section Scripts {
    <script>
        let display = document.getElementById('display');
        let currentInput = '0';
        let operator = null;
        let previousInput = null;
        let shouldResetDisplay = false;

        function updateDisplay() {
            // Форматируем число для отображения
            let displayValue = currentInput;
            if (displayValue !== 'Ошибка' && displayValue !== '0') {
                const num = parseFloat(displayValue);
                if (!isNaN(num)) {
                    // Если число слишком большое, используем экспоненциальную запись
                    if (Math.abs(num) >= 1e15 || (Math.abs(num) < 1e-10 && num !== 0)) {
                        displayValue = num.toExponential(6);
                    } else {
                        // Убираем лишние нули после запятой
                        displayValue = num.toString();
                    }
                }
            }
            display.textContent = displayValue;
        }

        function clearDisplay() {
            currentInput = '0';
            operator = null;
            previousInput = null;
            shouldResetDisplay = false;
            updateDisplay();
            addVisualFeedback('clear');
        }

        function deleteLast() {
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
            addVisualFeedback('delete');
        }

        function appendNumber(number) {
            if (shouldResetDisplay) {
                currentInput = number;
                shouldResetDisplay = false;
            } else {
                currentInput = currentInput === '0' ? number : currentInput + number;
            }
            updateDisplay();
            addVisualFeedback('number');
        }

        function appendDecimal() {
            if (shouldResetDisplay) {
                currentInput = '0.';
                shouldResetDisplay = false;
            } else if (currentInput.indexOf('.') === -1) {
                currentInput += '.';
            }
            updateDisplay();
            addVisualFeedback('decimal');
        }

        function appendOperator(op) {
            if (operator && !shouldResetDisplay) {
                calculate();
            }
            
            operator = op;
            previousInput = parseFloat(currentInput);
            shouldResetDisplay = true;
            addVisualFeedback('operator');
        }

        function calculate() {
            if (operator && previousInput !== null) {
                const current = parseFloat(currentInput);
                let result;

                switch (operator) {
                    case '+':
                        result = previousInput + current;
                        break;
                    case '-':
                        result = previousInput - current;
                        break;
                    case '*':
                        result = previousInput * current;
                        break;
                    case '/':
                        if (current === 0) {
                            currentInput = 'Ошибка';
                            updateDisplay();
                            addVisualFeedback('error');
                            return;
                        }
                        result = previousInput / current;
                        break;
                    default:
                        return;
                }

                // Округляем результат до 12 знаков после запятой для точности
                result = Math.round(result * 1e12) / 1e12;
                
                currentInput = result.toString();
                operator = null;
                previousInput = null;
                shouldResetDisplay = true;
                updateDisplay();
                addVisualFeedback('equals');
            }
        }

        // Простая функция без визуальных эффектов
        function addVisualFeedback(type) {
            // Убраны все визуальные эффекты
        }

        // Поддержка клавиатуры с улучшенной обработкой
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            // Предотвращаем стандартное поведение для некоторых клавиш
            if (['+', '-', '*', '/', '=', 'Enter'].includes(key)) {
                event.preventDefault();
            }
            
            if (key >= '0' && key <= '9') {
                appendNumber(key);
            } else if (key === '.' || key === ',') {
                appendDecimal();
            } else if (key === '+') {
                appendOperator('+');
            } else if (key === '-') {
                appendOperator('-');
            } else if (key === '*') {
                appendOperator('*');
            } else if (key === '/') {
                appendOperator('/');
            } else if (key === 'Enter' || key === '=') {
                calculate();
            } else if (key === 'Escape' || key.toLowerCase() === 'c') {
                clearDisplay();
            } else if (key === 'Backspace') {
                deleteLast();
            } else if (key === 'Delete') {
                clearDisplay();
            }
        });

        // Фокус на калькуляторе для работы с клавиатурой
        document.addEventListener('DOMContentLoaded', function() {
            document.body.focus();
            document.body.tabIndex = -1;
        });

        // Инициализация
        updateDisplay();
    </script>
}
